"""
Orquestrador principal da interface do usu√°rio
"""
import flet as ft
import threading
from ..core.session_state import get_session_state
from ..services.sharepoint_client import SharePointClient
from ..utils.data_utils import DataUtils
from ..utils.ui_utils import mostrar_mensagem, get_screen_size
from ..config.logging_config import setup_logger
from .screens.login import LoginScreen
from .screens.dashboard import DashboardScreen
from typing import Dict, Any, Optional
from ..config.logging_config import setup_logger
from ..services.auto_refresh_service import inicializar_auto_refresh, obter_auto_refresh_service
from ..ui.components.auto_refresh_indicator import criar_auto_refresh_indicator, obter_auto_refresh_indicator



logger = setup_logger()


class SentinelaApp:
    """Classe principal que orquestra toda a aplica√ß√£o"""
    
    def __init__(self, page: ft.Page):
        self.page = page
        self.login_screen = LoginScreen(page, self)
        self.dashboard_screen = DashboardScreen(page, self)
        self.carregando_dados = False
        self.auto_refresh_service = inicializar_auto_refresh(page, self)
        self.auto_refresh_indicator = criar_auto_refresh_indicator(page)
        self._configurar_auto_refresh_callbacks()
        
    """
Modifica√ß√µes para integrar Auto-Refresh na SentinelaApp
Localiza√ß√£o: app/ui/app_ui.py

INSTRU√á√ïES: Aplicar estas modifica√ß√µes no arquivo existente
"""

# ================================
# 1. IMPORTS ADICIONAIS (adicionar no topo)
# ================================
from ..services.auto_refresh_service import inicializar_auto_refresh, obter_auto_refresh_service
from ..ui.components.auto_refresh_indicator import criar_auto_refresh_indicator, obter_auto_refresh_indicator


# ================================
# 2. MODIFICA√á√ÉO NA CLASSE SentinelaApp
# ================================

class SentinelaApp:
    """Classe principal que orquestra toda a aplica√ß√£o - VERS√ÉO COM AUTO-REFRESH"""
    
    def __init__(self, page: ft.Page):
        self.page = page
        self.login_screen = LoginScreen(page, self)
        self.dashboard_screen = DashboardScreen(page, self)
        
        # NOVO: Status de carregamento
        self.carregando_dados = False
        
        # NOVO: Inicializa services de auto-refresh
        self.auto_refresh_service = inicializar_auto_refresh(page, self)
        self.auto_refresh_indicator = criar_auto_refresh_indicator(page)
        
        # NOVO: Configura callbacks entre services
        self._configurar_auto_refresh_callbacks()
        
    def _configurar_auto_refresh_callbacks(self):
        """Configura callbacks entre auto-refresh e indicador visual"""
        try:
            # Callback para atualiza√ß√£o de dados
            def callback_atualizacao():
                self.atualizar_dados(auto_refresh=True)
            
            # Callback para mudan√ßa de status
            def callback_status_mudou(status):
                if self.auto_refresh_indicator:
                    self.auto_refresh_indicator.atualizar_status(status)
                    
                    # Mostra toast em mudan√ßas importantes
                    estado_anterior = getattr(self, '_ultimo_estado_refresh', None)
                    estado_atual = status.get("estado")
                    
                    if estado_anterior != estado_atual and estado_anterior is not None:
                        self.auto_refresh_indicator.mostrar_toast_mudanca(estado_atual)
                    
                    self._ultimo_estado_refresh = estado_atual
            
            # Configura callbacks no service
            if self.auto_refresh_service:
                self.auto_refresh_service.configurar_callbacks(
                    callback_atualizacao=callback_atualizacao,
                    callback_status_mudou=callback_status_mudou
                )
                
            logger.info("‚úÖ Callbacks do auto-refresh configurados")
            
        except Exception as e:
            logger.error(f"‚ùå Erro ao configurar callbacks auto-refresh: {e}")

    def inicializar(self):
        """Inicializa a aplica√ß√£o"""
        logger.info("üöÄ Sentinela iniciando...")
        
        # Mostra tela de carregamento inicial
        self._mostrar_carregamento_inicial()
        
        # Carrega dados em background
        self._carregar_dados_iniciais()
    
    def _mostrar_carregamento_inicial(self):
        """Exibe tela de carregamento inicial"""
        loading_inicial = ft.Container(
            content=ft.Column([
                ft.ProgressRing(),
                ft.Text("Inicializando sistema...", size=16)
            ], horizontal_alignment=ft.CrossAxisAlignment.CENTER),
            alignment=ft.alignment.center
        )
        
        self.page.clean()
        self.page.add(loading_inicial)
        self.page.update()
    
    def _carregar_dados_iniciais(self):
        """Carrega dados iniciais para valida√ß√£o de login"""
        def carregar():
            try:
                logger.info("Carregando dados de usu√°rios...")
                session = get_session_state(self.page)
                session.df_usuarios = SharePointClient.carregar_lista("UsuariosPainelTorre")
                
                if not session.df_usuarios.empty:
                    logger.info(f"‚úÖ {len(session.df_usuarios)} usu√°rios carregados")
                    self.login_screen.mostrar()
                else:
                    logger.warning("‚ö†Ô∏è Nenhum usu√°rio encontrado")
                    self._mostrar_erro_inicial("Nenhum usu√°rio encontrado na base de dados")
                    
            except Exception as e:
                logger.error(f"‚ùå Erro ao carregar dados iniciais: {str(e)}")
                self._mostrar_erro_inicial(f"Erro ao conectar com SharePoint: {str(e)}")
        
        # Executa em thread separada
        thread = threading.Thread(target=carregar, daemon=True)
        thread.start()
    
    def _mostrar_erro_inicial(self, mensagem: str):
        """Exibe tela de erro inicial"""
        screen_size = get_screen_size(self.page.window_width)
        
        if screen_size == "small":
            icon_size = 60
            title_size = 16
            subtitle_size = 12
            button_width = 200
        elif screen_size == "medium":
            icon_size = 70
            title_size = 18
            subtitle_size = 13
            button_width = 250
        else:
            icon_size = 80
            title_size = 20
            subtitle_size = 14
            button_width = 300
        
        erro_container = ft.Container(
            content=ft.Column([
                ft.Icon(ft.icons.ERROR, size=icon_size, color=ft.colors.RED_600),
                ft.Text("Erro ao inicializar sistema", size=title_size, weight=ft.FontWeight.BOLD),
                ft.Text(mensagem, size=subtitle_size, color=ft.colors.GREY_600),
                ft.Container(height=20),
                ft.ElevatedButton(
                    "Tentar Novamente",
                    on_click=lambda e: self._carregar_dados_iniciais(),
                    bgcolor=ft.colors.BLUE_600,
                    color=ft.colors.WHITE,
                    width=button_width
                )
            ], horizontal_alignment=ft.CrossAxisAlignment.CENTER),
            alignment=ft.alignment.center,
            bgcolor=ft.colors.GREY_50
        )
        
        self.page.clean()
        self.page.add(erro_container)
        self.page.update()
    
    def fazer_login(self, email: str, senha: str) -> bool:
        """Processa login do usu√°rio"""
        try:
            # IMPORTANTE: Obt√©m sess√£o limpa para este usu√°rio
            session = get_session_state(self.page)
            
            # Garante que n√£o h√° dados de outro usu√°rio
            if session.usuario and session.usuario.get('Email', '').lower() != email.lower():
                logger.warning(f"‚ö†Ô∏è Limpando sess√£o anterior de {session.usuario.get('Email')}")
                session.reset_dados()
            
            # Valida credenciais
            sucesso, user_data = self._validar_login(email, senha)
            
            if not sucesso:
                return False
            
            # Armazena usu√°rio na sess√£o espec√≠fica
            session.usuario = user_data
            logger.info(f"‚úÖ Login bem-sucedido: {email} na sess√£o {session.session_id}")
            
            # Mostra tela de carregamento p√≥s-login
            self._mostrar_carregamento_pos_login()
            
            # Carrega dados completos em background
            self._carregar_dados_completos()
            
            return True
            
        except Exception as e:
            logger.error(f"‚ùå Erro no login: {str(e)}")
            return False
    
    def _validar_login(self, email: str, senha: str) -> tuple:
        """Valida credenciais do usu√°rio"""
        session = get_session_state(self.page)
        if session.df_usuarios.empty:
            return False, None
        
        # Busca coluna de email
        email_columns = [col for col in session.df_usuarios.columns if 'email' in col.lower()]
        if not email_columns:
            return False, None
        
        email_col = email_columns[0]
        
        # Busca usu√°rio
        email_normalizado = email.strip().lower()
        df_temp = session.df_usuarios.copy()
        df_temp['email_normalizado'] = df_temp[email_col].astype(str).str.strip().str.lower()
        
        usuario_df = df_temp[df_temp['email_normalizado'] == email_normalizado]
        
        if not usuario_df.empty:
            user_data = usuario_df.iloc[0]
            
            # Busca coluna de senha
            senha_columns = [col for col in user_data.index if any(palavra in col.lower() for palavra in ['senha', 'password', 'pass'])]
            
            if senha_columns:
                senha_col = senha_columns[0]
                senha_bd = str(user_data[senha_col]).strip()
                
                if str(senha).strip() == senha_bd:
                    return True, user_data.to_dict()
        
        return False, None
    
    def _mostrar_carregamento_pos_login(self):
        """Mostra tela de carregamento ap√≥s login"""
        session = get_session_state(self.page)
        nome_usuario = session.get_nome_usuario()
        
        # Configura√ß√µes responsivas
        screen_size = get_screen_size(self.page.window_width)
        
        if screen_size == "small":
            circulo_size = 180
            logo_size = 160
            welcome_size = 18
            loading_size = 14
            subtitle_size = 12
        elif screen_size == "medium":
            circulo_size = 240
            logo_size = 220
            welcome_size = 20
            loading_size = 15
            subtitle_size = 13
        else:
            circulo_size = 300
            logo_size = 280
            welcome_size = 24
            loading_size = 16
            subtitle_size = 14
        
        loading_container = ft.Container(
            content=ft.Column([
                ft.Container(expand=True),
                ft.Container(
                    content=ft.Stack([
                        ft.Container(
                            content=ft.Image(
                                src="images/circulo.png",
                                width=circulo_size,
                                height=circulo_size,
                                fit=ft.ImageFit.CONTAIN
                            ),
                            alignment=ft.alignment.center
                        ),
                        ft.Container(
                            content=ft.Image(
                                src="images/sentinela.png",
                                width=logo_size,
                                height=logo_size,
                                fit=ft.ImageFit.CONTAIN
                            ),
                            alignment=ft.alignment.center
                        )
                    ]),
                    height=circulo_size,
                    alignment=ft.alignment.center
                ),
                ft.Container(height=30),
                ft.Column([
                    ft.Text(
                        f"Bem-vindo, {nome_usuario}!",
                        size=welcome_size,
                        weight=ft.FontWeight.BOLD,
                        color=ft.colors.BLUE_800,
                        text_align=ft.TextAlign.CENTER
                    ),
                    ft.Container(height=8),
                    ft.Text(
                        "Carregando seu painel...",
                        size=loading_size,
                        color=ft.colors.BLUE_600,
                        text_align=ft.TextAlign.CENTER
                    ),
                    ft.Text(
                        "Aguarde alguns instantes",
                        size=subtitle_size,
                        color=ft.colors.GREY_600,
                        text_align=ft.TextAlign.CENTER
                    )
                ], horizontal_alignment=ft.CrossAxisAlignment.CENTER),
                ft.Container(expand=True)
            ]),
            alignment=ft.alignment.center,
            bgcolor=ft.colors.WHITE,
            expand=True
        )
        
        self.page.clean()
        self.page.add(loading_container)
        self.page.update()
    
    def _carregar_dados_completos(self):
        """Carrega todos os dados da aplica√ß√£o"""
        def carregar():
            try:
                logger.info("Carregando dados completos...")
                
                session = get_session_state(self.page)
                # Carrega desvios
                session.df_desvios = SharePointClient.carregar_lista("Desvios")
                
                # Processa dados
                session.df_desvios = DataUtils.processar_desvios(session.df_desvios)
                
                # Marca como carregado
                session.dados_carregados = True
                
                logger.info(f"‚úÖ Dados carregados: {len(session.df_desvios)} desvios")
                
                # Mostra dashboard
                self.dashboard_screen.mostrar()
                
            except Exception as e:
                logger.error(f"‚ùå Erro ao carregar dados: {str(e)}")
                self._mostrar_erro_dados()
        
        # Executa em thread separada
        thread = threading.Thread(target=carregar, daemon=True)
        thread.start()
    
    def _mostrar_erro_dados(self):
        """Mostra erro ao carregar dados"""
        screen_size = get_screen_size(self.page.window_width)
        
        if screen_size == "small":
            icon_size = 60
            title_size = 16
            subtitle_size = 12
            button_width = 200
        elif screen_size == "medium":
            icon_size = 70
            title_size = 18
            subtitle_size = 13
            button_width = 250
        else:
            icon_size = 80
            title_size = 20
            subtitle_size = 14
            button_width = 300
        
        erro_container = ft.Container(
            content=ft.Column([
                ft.Icon(ft.icons.ERROR, size=icon_size, color=ft.colors.RED_600),
                ft.Text("Erro ao carregar dados", size=title_size, weight=ft.FontWeight.BOLD),
                ft.Text("Verifique sua conex√£o com a internet", size=subtitle_size, color=ft.colors.GREY_600),
                ft.Container(height=20),
                ft.ElevatedButton(
                    "Tentar Novamente",
                    on_click=lambda e: self._carregar_dados_completos(),
                    bgcolor=ft.colors.BLUE_600,
                    color=ft.colors.WHITE,
                    width=button_width
                )
            ], horizontal_alignment=ft.CrossAxisAlignment.CENTER),
            alignment=ft.alignment.center,
            bgcolor=ft.colors.GREY_50
        )
        
        self.page.clean()
        self.page.add(erro_container)
        self.page.update()
    
    def atualizar_dados(self, auto_refresh=False):
        """
        Atualiza dados do sistema
        
        Args:
            auto_refresh: True se chamado pelo timer autom√°tico
        """
        if self.carregando_dados:
            if not auto_refresh:  # S√≥ mostra aviso se n√£o for auto-refresh
                mostrar_mensagem(self.page, "‚è≥ Atualiza√ß√£o j√° em andamento...", "info")
            return

        try:
            self.carregando_dados = True
            session = get_session_state(self.page)
            
            if not auto_refresh:
                mostrar_mensagem(self.page, "üîÑ Atualizando dados...", "info")
            else:
                logger.info("üîÑ Auto-refresh executando atualiza√ß√£o...")
            
            # Carrega dados atualizados
            df_usuarios_novo = SharePointClient.obter_usuarios()
            df_desvios_novo = SharePointClient.obter_desvios()
            
            if not df_usuarios_novo.empty and not df_desvios_novo.empty:
                # Processa dados
                df_desvios_processado = DataUtils.processar_desvios_completo(df_desvios_novo)
                
                # Atualiza sess√£o
                session.df_usuarios = df_usuarios_novo
                session.df_desvios = df_desvios_processado
                session.dados_carregados = True
                
                # Reconstr√≥i interface atual
                self._reconstruir_interface_atual()
                
                if not auto_refresh:
                    mostrar_mensagem(self.page, "‚úÖ Dados atualizados com sucesso!", "success")
                else:
                    logger.info("‚úÖ Auto-refresh conclu√≠do com sucesso")
                    
            else:
                if not auto_refresh:
                    mostrar_mensagem(self.page, "‚ö†Ô∏è Erro ao carregar dados atualizados", "warning")
                else:
                    logger.warning("‚ö†Ô∏è Auto-refresh: erro ao carregar dados")
                
        except Exception as e:
            logger.error(f"‚ùå Erro na atualiza√ß√£o de dados: {e}")
            if not auto_refresh:
                mostrar_mensagem(self.page, f"‚ùå Erro: {str(e)}", "error")
        finally:
            self.carregando_dados = False

    def _reconstruir_interface_atual(self):
        """Reconstr√≥i a interface atual ap√≥s atualiza√ß√£o de dados"""
        try:
            session = get_session_state(self.page)
            
            # Verifica qual tela est√° ativa e reconstr√≥i
            if session.is_usuario_logado():
                # Reconstr√≥i dashboard (tela principal)
                self.mostrar_dashboard()
                
        except Exception as e:
            logger.error(f"‚ùå Erro ao reconstruir interface: {e}")

    def inicializar_auto_refresh_para_usuario(self):
        """Inicializa auto-refresh baseado nas configura√ß√µes do usu√°rio"""
        try:
            session = get_session_state(self.page)
            
            # Verifica configura√ß√£o do usu√°rio
            auto_refresh_habilitado = session.obter_configuracao_usuario('auto_refresh', False)
            
            if auto_refresh_habilitado and self.auto_refresh_service:
                logger.info(f"üîÑ Habilitando auto-refresh para usu√°rio {session.get_nome_usuario()}")
                self.auto_refresh_service.habilitar_usuario(True)
            else:
                logger.info(f"üîï Auto-refresh desabilitado para usu√°rio {session.get_nome_usuario()}")
                
        except Exception as e:
            logger.error(f"‚ùå Erro ao inicializar auto-refresh: {e}")

    def parar_auto_refresh(self):
        """Para o auto-refresh (usado no logout)"""
        try:
            if self.auto_refresh_service:
                self.auto_refresh_service.parar_timer()
                
            if self.auto_refresh_indicator:
                self.auto_refresh_indicator.parar_atualizacao()
                
            logger.info("üõë Auto-refresh parado")
            
        except Exception as e:
            logger.error(f"‚ùå Erro ao parar auto-refresh: {e}")

    def obter_componente_auto_refresh_indicator(self):
        """
        Retorna componente do indicador para integra√ß√£o no header
        
        Returns:
            ft.Container: Componente visual do indicador
        """
        if self.auto_refresh_indicator:
            return self.auto_refresh_indicator.criar_indicador()
        return ft.Container()  # Container vazio se n√£o dispon√≠vel
      
    def registrar_campo_para_monitoring(self, campo_id: str, valor_original: any):
        """
        Registra um campo para monitoramento de altera√ß√µes
        
        Args:
            campo_id: Identificador √∫nico do campo
            valor_original: Valor original do campo
        """
        try:
            session = get_session_state(self.page)
            session.registrar_campo_original(campo_id, valor_original)
        except Exception as e:
            logger.error(f"‚ùå Erro ao registrar campo: {e}")

    def notificar_alteracao_campo(self, campo_id: str, novo_valor: any):
        """
        Notifica altera√ß√£o em um campo
        
        Args:
            campo_id: Identificador √∫nico do campo
            novo_valor: Novo valor do campo
        """
        try:
            session = get_session_state(self.page)
            session.registrar_alteracao_campo(campo_id, novo_valor)
        except Exception as e:
            logger.error(f"‚ùå Erro ao notificar altera√ß√£o: {e}")

    def limpar_alteracoes_campos(self):
        """Limpa todas as altera√ß√µes de campos (ap√≥s salvar)"""
        try:
            session = get_session_state(self.page)
            session.limpar_alteracoes_campos()
            logger.info("‚úÖ Altera√ß√µes de campos limpas")
        except Exception as e:
            logger.error(f"‚ùå Erro ao limpar altera√ß√µes: {e}")

    def mostrar_dashboard(self):
        """Mostra a tela do dashboard"""
        self.dashboard_screen.mostrar()
    
    def fazer_logout(self):
        """Faz logout do usu√°rio - VERS√ÉO ATUALIZADA"""
        try:
            # NOVO: Para auto-refresh antes do logout
            self.parar_auto_refresh()
            
            # Limpeza existente
            session = get_session_state(self.page)
            session.reset_dados()
            
            # Volta para tela de login
            self.login_screen.mostrar()
            
            logger.info("‚úÖ Logout realizado com sucesso")
            
        except Exception as e:
            logger.error(f"‚ùå Erro no logout: {e}")

try:
    from ..services.suzano_password_service import suzano_password_service
    PASSWORD_SERVICE_AVAILABLE = True
except ImportError:
    PASSWORD_SERVICE_AVAILABLE = False
    suzano_password_service = None


class PasswordManager:
    """Gerenciador simplificado para opera√ß√µes de senha"""
    
    @staticmethod
    def is_service_available() -> bool:
        """
        Verifica se o servi√ßo de senha est√° dispon√≠vel
        
        Returns:
            bool: True se servi√ßo est√° dispon√≠vel
        """
        return PASSWORD_SERVICE_AVAILABLE and suzano_password_service is not None
    
    @staticmethod
    def validate_password_policy(password: str) -> Dict[str, Any]:
        """
        Valida pol√≠tica de senha
        
        Args:
            password: Senha a ser validada
            
        Returns:
            Dict com resultado da valida√ß√£o
        """
        if not PasswordManager.is_service_available():
            return {
                'valid': False,
                'error': 'Servi√ßo de senha n√£o dispon√≠vel'
            }
        
        try:
            is_valid, message = suzano_password_service.validar_politica_senha(password)
            return {
                'valid': is_valid,
                'message': message,
                'error': None if is_valid else message
            }
        except Exception as e:
            logger.error(f"‚ùå Erro ao validar pol√≠tica de senha: {e}")
            return {
                'valid': False,
                'error': f'Erro na valida√ß√£o: {str(e)}'
            }
    
    @staticmethod
    def change_user_password(email: str, current_password: str, new_password: str) -> Dict[str, Any]:
        """
        Altera senha do usu√°rio
        
        Args:
            email: Email do usu√°rio
            current_password: Senha atual
            new_password: Nova senha
            
        Returns:
            Dict com resultado da opera√ß√£o
        """
        if not PasswordManager.is_service_available():
            return {
                'success': False,
                'error': 'Servi√ßo de senha n√£o dispon√≠vel',
                'user_message': 'Funcionalidade de troca de senha temporariamente indispon√≠vel'
            }
        
        try:
            logger.info(f"üîê Iniciando troca de senha para: {email}")
            
            resultado = suzano_password_service.alterar_senha(
                email=email,
                senha_atual=current_password,
                nova_senha=new_password
            )
            
            if resultado.get('sucesso', False):
                logger.info(f"‚úÖ Senha alterada com sucesso para: {email}")
                return {
                    'success': True,
                    'message': resultado.get('mensagem', 'Senha alterada com sucesso'),
                    'user_message': 'üîê Sua senha foi alterada com sucesso!',
                    'user_id': resultado.get('usuario_id')
                }
            else:
                error_msg = resultado.get('erro', 'Erro desconhecido')
                logger.warning(f"‚ö†Ô∏è Falha na troca de senha para {email}: {error_msg}")
                
                # Mapeia erros para mensagens mais amig√°veis
                user_friendly_errors = {
                    'senha atual incorreta': 'A senha atual informada est√° incorreta',
                    'usu√°rio n√£o encontrado': 'Usu√°rio n√£o encontrado no sistema',
                    'pol√≠tica de senha': 'A nova senha n√£o atende aos requisitos de seguran√ßa',
                    'conex√£o': 'Erro de conex√£o com o servidor. Tente novamente.'
                }
                
                user_message = error_msg
                for key, friendly_msg in user_friendly_errors.items():
                    if key in error_msg.lower():
                        user_message = friendly_msg
                        break
                
                return {
                    'success': False,
                    'error': error_msg,
                    'user_message': user_message
                }
                
        except Exception as e:
            logger.error(f"‚ùå Erro cr√≠tico na troca de senha: {e}")
            return {
                'success': False,
                'error': str(e),
                'user_message': 'Erro interno do sistema. Contate o suporte t√©cnico.'
            }
    
    @staticmethod
    def verify_current_password(email: str, password: str) -> bool:
        """
        Verifica se a senha atual est√° correta
        
        Args:
            email: Email do usu√°rio
            password: Senha a ser verificada
            
        Returns:
            bool: True se senha est√° correta
        """
        if not PasswordManager.is_service_available():
            logger.warning("‚ö†Ô∏è Tentativa de verifica√ß√£o de senha sem servi√ßo dispon√≠vel")
            return False
        
        try:
            return suzano_password_service.validar_senha_atual(email, password)
        except Exception as e:
            logger.error(f"‚ùå Erro ao verificar senha atual: {e}")
            return False
    
    @staticmethod
    def get_user_info(email: str) -> Optional[Dict[str, Any]]:
        """
        Obt√©m informa√ß√µes do usu√°rio
        
        Args:
            email: Email do usu√°rio
            
        Returns:
            Dict com dados do usu√°rio ou None
        """
        if not PasswordManager.is_service_available():
            return None
        
        try:
            return suzano_password_service.obter_dados_usuario(email)
        except Exception as e:
            logger.error(f"‚ùå Erro ao obter dados do usu√°rio: {e}")
            return None
    
    @staticmethod
    def test_service_connection() -> Dict[str, Any]:
        """
        Testa conex√£o com o servi√ßo
        
        Returns:
            Dict com resultado do teste
        """
        if not PasswordManager.is_service_available():
            return {
                'connected': False,
                'message': 'Servi√ßo n√£o dispon√≠vel',
                'details': 'Biblioteca ou configura√ß√£o ausente'
            }
        
        try:
            connected = suzano_password_service.testar_conexao()
            return {
                'connected': connected,
                'message': 'Conectado com sucesso' if connected else 'Falha na conex√£o',
                'details': 'SharePoint acess√≠vel' if connected else 'Verificar credenciais e rede'
            }
        except Exception as e:
            return {
                'connected': False,
                'message': 'Erro no teste de conex√£o',
                'details': str(e)
            }
    
    @staticmethod
    def get_password_requirements() -> Dict[str, Any]:
        """
        Retorna requisitos da pol√≠tica de senha
        
        Returns:
            Dict com requisitos da senha
        """
        return {
            'min_length': 6,
            'max_length': 50,
            'requires_letter': False,  # Conforme configura√ß√£o Suzano
            'requires_number': False,
            'requires_special': False,
            'description': [
                'M√≠nimo de 6 caracteres',
                'M√°ximo de 50 caracteres',
                'N√£o pode estar vazia',
                'Recomendado: use uma combina√ß√£o de letras, n√∫meros e s√≠mbolos'
            ]
        }


# Fun√ß√µes de conveni√™ncia para uso direto
def alterar_senha(email: str, senha_atual: str, nova_senha: str) -> Dict[str, Any]:
    """
    Fun√ß√£o de conveni√™ncia para alterar senha
    
    Args:
        email: Email do usu√°rio
        senha_atual: Senha atual
        nova_senha: Nova senha
        
    Returns:
        Dict com resultado da opera√ß√£o
    """
    return PasswordManager.change_user_password(email, senha_atual, nova_senha)


def validar_senha(senha: str) -> Dict[str, Any]:
    """
    Fun√ß√£o de conveni√™ncia para validar senha
    
    Args:
        senha: Senha a ser validada
        
    Returns:
        Dict com resultado da valida√ß√£o
    """
    return PasswordManager.validate_password_policy(senha)


def servico_disponivel() -> bool:
    """
    Fun√ß√£o de conveni√™ncia para verificar disponibilidade do servi√ßo
    
    Returns:
        bool: True se servi√ßo est√° dispon√≠vel
    """
    return PasswordManager.is_service_available()


def obter_requisitos_senha() -> Dict[str, Any]:
    """
    Fun√ß√£o de conveni√™ncia para obter requisitos de senha
    
    Returns:
        Dict com requisitos da senha
    """
    return PasswordManager.get_password_requirements()


def testar_servico() -> Dict[str, Any]:
    """
    Fun√ß√£o de conveni√™ncia para testar servi√ßo
    
    Returns:
        Dict com resultado do teste
    """
    return PasswordManager.test_service_connection()